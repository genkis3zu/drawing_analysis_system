# アクティブコンテキスト：A4図面解析システム

## 現在の作業フォーカス

現在、A4図面解析システムは開発の初期段階にあります。主なフォーカスは以下の領域です：

1. **コア解析エンジンの開発**
   - A4図面の検出と最適化機能の実装
   - OpenAI GPT-4 Visionを活用した図面解析機能の実装
   - 解析結果の構造化と後処理

2. **画像処理モジュールの最適化**
   - A4サイズ検出アルゴリズムの精度向上
   - 画質向上処理の実装と調整
   - レイアウト特徴抽出機能の開発
   - ✅ 画像処理モジュールのテスト実装

3. **エクセル出力機能の実装**
   - 解析結果の整形されたエクセル出力
   - 信頼度に基づく視覚的フィードバック
   - バッチレポート生成機能

## 最近の変更

### コードベース整理
- `src/models/file_handler.py`を削除（`src/utils/file_handler.py`と重複していたため）
- `test_image_processor.py`を作成し、A4ImageProcessorクラスのユニットテストを実装
- `test_image_processor_direct.py`を作成し、A4ImageProcessorクラスの直接テストを実装

### 画像処理モジュール
- A4サイズ検出アルゴリズムを改良し、より厳密な±2mmの許容誤差を実装
- 画質向上処理に適応的ヒストグラム平坦化とバイラテラルフィルタを追加
- PDFサポートを追加し、pdf2imageを使用してPDFの最初のページを画像として処理可能に

### 解析エージェント
- テンプレートベースの解析と新規解析の2つの戦略を実装
- 解析結果の信頼度スコアリングシステムを導入
- エラー処理とフォールバックメカニズムを強化

### エクセル出力
- 解析結果、メタデータ、品質評価の3つのシートを含むレポート形式を設計
- 信頼度に基づく色分けを実装（高信頼度：緑、中信頼度：黄、低信頼度：赤）
- バッチレポート機能を追加し、複数図面の一括処理結果をまとめて出力可能に

## 現在の課題

1. **解析精度の向上**
   - 特に低品質図面での認識精度が目標に達していない
   - 特定の図面要素（寸法線、公差記号など）の認識が不安定
   - 日本語テキストの認識精度向上が必要

2. **パフォーマンスの最適化**
   - 画像処理に時間がかかりすぎる（特に高解像度画像）
   - OpenAI API呼び出しの最適化が必要
   - バッチ処理時のメモリ使用量が高い

3. **テンプレート機能の拡充**
   - テンプレートマッチングアルゴリズムの精度向上
   - テンプレート管理UIの開発
   - 学習データの効果的な活用方法

## 次のステップ

### 短期的なタスク（1-2週間）
1. **A4ImageProcessorのテスト強化** ✅
   - ✅ 様々な品質・サイズの図面でのテストケース追加
   - ✅ エッジケース（極端に低品質、非標準サイズなど）の処理改善
   - 🔄 パフォーマンス最適化（メモリ使用量削減、処理速度向上）

2. **DrawingAnalysisAgentの機能拡張**
   - プロンプトエンジニアリングの改善（より精度の高い抽出のための指示）
   - 複数回の解析結果の統合による精度向上
   - 信頼度評価アルゴリズムの調整

3. **ExcelManagerの機能強化**
   - より詳細な解析メトリクスの追加
   - カスタマイズ可能なレポートテンプレート
   - データの視覚化（グラフ、チャートの追加）

### 中期的なタスク（1-2ヶ月）
1. **テンプレート管理システムの実装**
   - テンプレート作成・編集UI
   - テンプレートのバージョン管理
   - テンプレート適用条件の詳細設定

2. **バッチ処理システムの強化**
   - 並列処理の実装
   - 進捗モニタリングとレポート
   - エラーハンドリングと自動リトライ

3. **学習システムの実装**
   - ユーザーフィードバックの収集メカニズム
   - フィードバックに基づくテンプレート自動更新
   - 解析精度の継続的改善サイクル

## 重要な決定事項

1. **A4サイズ専用設計**
   - システムはA4サイズ図面に特化し、他のサイズはサポート外とする
   - 非A4サイズの図面は自動的にA4に最適化する機能を提供

2. **OpenAI GPT-4 Vision依存**
   - 現段階では独自モデル開発よりもGPT-4 Visionの活用を優先
   - 将来的にはハイブリッドアプローチ（一部処理を独自モデルに置き換え）を検討

3. **SQLiteデータベース採用**
   - 軽量で導入が容易なSQLiteを採用
   - 将来的なスケーリングニーズに応じて他のDBMSへの移行も視野に

4. **モジュラー設計の徹底**
   - 各コンポーネントは明確に分離し、独立してテスト・改善可能に
   - 将来的な拡張性を考慮したインターフェース設計

## 学習と洞察

1. **図面解析の複雑性**
   - 図面は単なる画像ではなく、構造化された情報の集合体
   - コンテキスト理解が重要（例：寸法線と数値の関連付け）
   - 図面の種類によって最適な解析アプローチが異なる

2. **AI活用の効果と限界**
   - GPT-4 Visionは驚くほど柔軟な認識能力を持つ
   - プロンプトエンジニアリングが精度に大きく影響
   - 特定のドメイン知識（製図規格など）の明示的な提供が重要

3. **ユーザー中心設計の重要性**
   - 技術的に優れていても使いにくければ採用されない
   - エラーや低信頼度結果の明示的な表示が重要
   - ユーザーによる修正・フィードバックの容易さが鍵

4. **テスト駆動開発の有効性**
   - 画像処理モジュールのテスト実装により、エッジケースの発見と対応が容易に
   - ユニットテストと直接テストの両方を実装することで、異なる視点からの検証が可能
   - テストケースの充実により、リファクタリングや機能追加時の安全性が向上

## 現在のプロジェクト状態

### 実装済み機能
- ✅ A4図面の検出と最適化
- ✅ 基本的な画像処理と品質向上
- ✅ OpenAI GPT-4 Visionを使用した図面解析
- ✅ 解析結果のエクセル出力
- ✅ 基本的なバッチ処理
- ✅ 画像処理モジュールのテスト

### 開発中の機能
- 🔄 テンプレートマッチングと活用
- 🔄 学習システム
- 🔄 詳細な品質評価メトリクス
- 🔄 パフォーマンス最適化

### 未着手の機能
- ❌ ユーザーインターフェース（Streamlit）
- ❌ テンプレート管理UI
- ❌ バッチ処理の並列化
- ❌ 詳細なエラーレポートとトラブルシューティング
- ❌ システムモニタリングダッシュボード

## 環境設定とツール

### 開発環境
- Python 3.10
- Visual Studio Code + Python拡張
- Git for Windows/Mac/Linux

### 主要ライブラリのバージョン
- OpenCV: 4.7.0
- Pillow: 9.5.0
- pdf2image: 1.16.3
- OpenPyXL: 3.1.2
- Pandas: 2.0.3
- NumPy: 1.24.3
- SQLite: 3.41.2

### APIキー設定
OpenAI APIキーは`config.yaml`ファイルで設定：
```yaml
openai:
  api_key: "your-api-key-here"
  model: "gpt-4-vision-preview"
  max_tokens: 2000
  temperature: 0.1
```

## コミュニケーションノート

### チーム内共有事項
- A4サイズ検出アルゴリズムの改良により、誤検出が50%減少
- テンプレートマッチングの初期実装で、類似図面の処理時間が40%短縮
- エクセル出力の書式設定により、解析結果の可読性が大幅に向上
- 画像処理モジュールのテスト実装により、エッジケースの検出と対応が強化

### ユーザーフィードバック
- 「信頼度表示が非常に役立つ。低信頼度項目を優先的に確認できる」
- 「バッチ処理機能は便利だが、途中経過が見えるとより良い」
- 「特定の製図記号（特に公差記号）の認識精度向上を希望」

### 外部依存関係の注意点
- OpenAI APIの利用制限に注意（レート制限、コスト）
- pdf2imageはPopperに依存するため、環境によってはインストールが複雑
- 高解像度画像処理時のメモリ使用量に注意
